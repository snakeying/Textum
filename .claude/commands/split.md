# 阶段3: Story 拆分（v1）

读取 `docs/PRD.md` 和 `docs/GLOBAL-CONTEXT.md`，按本文指令拆分，按 `.claude/textum/story-template-v6.md` 格式生成 `docs/story-N-xxx.md`。

## 输入文件

- PRD: `docs/PRD.md`
- 全局上下文: `docs/GLOBAL-CONTEXT.md`
- 模板: `.claude/textum/story-template-v6.md`

## 任务

将 PRD 按功能模块（`M-xx`）拆分为可独立交付的 Story 文件；并确保数据/接口/规则都能被后续 `/story N` 精确引用与实现。

## 行号引用规则（必须遵守）

**必须使用精确行号格式**: `PRD:L[起]-L[止]`

1. 读取 PRD 时，记录每个引用段落的实际行号
2. 数据表定义 → 记录该表从字段行到最后一个字段行的行范围
3. 接口定义 → 记录从路径到响应（含失败场景）的完整行范围
4. 业务规则 → 记录规则所在行（或规则表对应行范围）

示例:
```
- 定义: PRD:L259-L267      (某数据表)
- 定义: PRD:L406-L409      (某接口)
- PRD:L121-L122: 某业务规则描述
```

## 稳定ID引用（推荐）

为降低行号变化带来的风险，PRD 中的表/接口应有稳定ID：

- 表: `TBL-###`
- 接口: `API-###`

在 Story 的“数据变更/接口”中尽量同时引用稳定ID + `PRD:Lx-Ly`（示例见 Story 模板）。

## 拆分原则

1. **单一职责**: 每个 Story 聚焦一个模块/一个可交付能力
2. **依赖清晰**: 明确前置 Story，避免循环依赖
3. **可独立交付**: 完成后可独立测试验收
4. **粒度适中**: 单 Story 预估 1-3 天工作量

## 拆分顺序建议

```
1. 基础设施层（数据库/配置）
2. 认证与权限
3. 核心实体管理
4. 主业务流程
5. 辅助功能
6. 管理后台
```

## 关键映射（防漏）

- **模块主线**: 以 PRD 的模块清单 `M-xx` 为主线生成 Story，并在每个 Story 顶部填写 `模块（必填）: M-xx`
- **接口归属**: 以 PRD `9.2 接口清单` 的“模块列”归类接口到对应 Story，确保每条接口至少被一个 Story 覆盖
- **规则引用**: 每个 Story 的“业务规则”优先用 `GC#BR-###` 格式（并补充对应 `PRD:Lx-Ly` 行号依据）

## 输出要求

1. 按 `.claude/textum/story-template-v6.md` 格式生成
2. 文件命名: `story-[编号]-[简称].md`
3. 编号即执行顺序：若某 Story 声明 `前置Story: Story X`，则必须满足 `X < 当前编号`（确保用户可按 `/story 1..N` 顺序执行）
4. 每个 Story 的 PRD 引用必须包含精确行号（数据/接口/规则）；数据表/接口尽量附带 `TBL-###` / `API-###` 稳定ID
5. 每个 Story 必须写清：功能点、依赖（前置 Story + 已有资源）、验收标准、测试要求
6. 模板中的每个章节都必须出现；无内容写 `N/A`，不要省略章节
7. 生成 Story 依赖关系图（可先在拆分结果摘要里给出）
8. 拆分完成后必须运行 `/split-check` 校验；通过后运行 `/backfill` 回填索引到 `docs/GLOBAL-CONTEXT.md`

## 一致性检查（必须做）

- 覆盖检查：所有 `P0` 模块、核心表、关键接口至少被一个 Story 覆盖
- 依赖检查：无循环依赖；如有环，调整 Story 边界或拆分/前置顺序
- 顺序检查：所有 `前置Story` 的编号必须小于当前 Story 编号（保证可按 `/story 1..N` 顺序执行）
- 命名检查：Story 简称稳定、可读，避免与未来功能冲突

## 开始

请确认 `docs/PRD.md`（顶部 `状态: Final`）和 `docs/GLOBAL-CONTEXT.md` 已存在；禁止修改 `docs/PRD.md`。
